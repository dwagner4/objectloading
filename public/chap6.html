<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Chap3</title>
		<style>
			body { margin: 0; }
		</style>
	</head>
	<body>
		<script src="build/three.js"></script>

		<script type="module">
			import { setUpLighting }from './chap6scripts/lighting.js'
			import { makeCamera }from './chap6scripts/ch6camera.js'
			import { makeAvatar }from './chap6scripts/avatar.js'
			import { makeLandscape }from './chap6scripts/landscape.js'
			import { walk }from './chap6scripts/animations.js'

			var scene = new THREE.Scene();
			var clock = new THREE.Clock();
 
			makeLandscape( scene )
			var light = setUpLighting()
			var camera = makeCamera()
			var avatar = makeAvatar()
			

			var marker = new THREE.Object3D();
			marker.add(avatar);
			marker.add(camera);
			
			scene.add(light);
			scene.add(marker);

			var renderer = new THREE.WebGLRenderer({antialias: true});
			renderer.setSize(window.innerWidth, window.innerHeight);
			document.body.appendChild(renderer.domElement);

			var isCartwheeling = false;
			var isFlipping = false;
			var isMovingRight = false;
			var isMovingLeft = false;
			var isMovingForward = false
			var isMovingBack = false;

			function moveAvatar() { 
				if ( isMovingRight || isMovingLeft || isMovingForward || isMovingBack ) {
					var time = clock.getElapsedTime();
					walk( avatar, time );
				}
				if (isCartwheeling) { 
					avatar.rotation.z = avatar.rotation.z + 0.05;
				}
				if (isFlipping) {
					avatar.rotation.x = avatar.rotation.x + 0.05;
				}
			}

			document.addEventListener('keydown', sendKeyDown);

			function sendKeyDown(event) {
				var code = event.code;
				if (code == 'ArrowLeft') {
					marker.position.x = marker.position.x - 5;
					isMovingLeft = true;
				}
				if (code == 'ArrowRight') {
					marker.position.x = marker.position.x + 5;
					isMovingRight = true;
				}
				if (code == 'ArrowUp') {
					marker.position.z = marker.position.z - 5;
					isMovingForward = true;
				}
				if (code == 'ArrowDown') {
					marker.position.z = marker.position.z + 5;
					isMovingBack = true;
				}
				if (code == 'KeyC') isCartwheeling = !isCartwheeling;
				if (code == 'KeyF') isFlipping = !isFlipping;
			}

			document.addEventListener('keyup', sendKeyUp);
			function sendKeyUp(event) {
				var code = event.code;
				if (code == 'ArrowLeft') isMovingLeft = false;
				if (code == 'ArrowRight') isMovingRight = false;
				if (code == 'ArrowUp') isMovingForward = false;
				if (code == 'ArrowDown') isMovingBack = false;
			}

			function animate() {
				requestAnimationFrame(animate);
				moveAvatar()
				renderer.render(scene, camera);
			}
			animate();

		</script>
	</body>
</html>